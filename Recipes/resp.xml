<?xml version="1.0" encoding="UTF-8" ?>

<!-- RESP Recipe -->
<!--
    Calculations:
    1: opt=loose PM6 
    2: HF/6-31g(d) SCF=Conver=8 opt=tight 
    3: HF/6-31g(d) SCF=Conver=8 Pop=MK IOp(6/41=$(ESP_LAYERS),6/42=$(ESP_DENSITY),6/77=$(RESP_RESTRAINT))
-->

<!-- SPECIAL VARIABLES -->
<!--

residueState:
    Select residues of a particular type
    If not specified, selects the entire geometry

    The following are accepted:
    $(STANDARD):     Standard residues
    $(NONSTANDARD):  Non-Standard residues
    $(ION):          Metal ions
    $(C_TERMINAL):   Carbon terminal residues
    $(N_TERMINAL):   Nitrogen terminal residues
    $(HETERO):       Hetero-Residues
    $(WATER):        Water residues
    $(CAP):          Cap residues

    Usage examples (where applicable):
        <residueState></residueState>              Select all
        <residueState>$(STANDARD)</residueState>   Select Standard
        

-->


<recipe>
    <!-- Number of processors to use in all calculations -->
    <var id="NPROC">4</var>

    <!-- Number of ESP Layers to use in ESP Calculation -->
    <var id="ESP_LAYERS">10</var>

    <!-- Density of ESP Fitting Points to use per ESP Layer in ESP Calculation -->
    <var id="ESP_DENSITY">17</var>

    <!-- Restraint on charge in ESP Calculation (use 0 for ESP) -->
    <var id="RESP_RESTRAINT">50</var>

<!-- Caclulation group -->
<!--
    type:
        connected:  run separate calculations for each group of connected residues
        perResidue: run separate calculations for each residue
        geometry:   run calculations on the entire geometry
    name:
        variable name to use for the group
    source:
        source of the geometry to split
        $(GEOMETRY) is a reserved variable for the input geometry
-->
    <group type="connected" name="residueGroup" source="$(GEOMETRY)">


        <!-- Actions -->
        <!--
            
            MoveToReal:
                Move selected residues to Real Layer

                Params:
                residueState:
                    See SPECIAL VARIABLES section
                residueIDs:
                    Select comma separated Residue IDs
                    e.g.:
                        <residueIDs>A32,A33,A34</residueIDs>

            MoveToIntermediate:
                Move selected residues to Intermediate Layer
                Params as above

            MoveToModel:
                Move selected residues to Model Layer
                Params as above

            EstimateChargeMultiplicity:
                Estimate the charge and multiplicity based on valence.
                Params:
                    confirm (optional): Ask user for confirmation
                e.g.:
                    <action id="EstimateChargeMultiplicity"><confirm /></action>

            GenerateAtomMap:
                Maps the Atomic index to AtomID.
                Should be performed whenever atoms might be changed before calculations

            RedistributeCharge:
                Moves charges from Caps to Residues
                Params:
                    distribution:
                        The amount of charge to distribute to each bonded distance from the link between the Cap and the Residue
                        Should (usually) sum to 1.
                        Zeros the charge on the Cap residue/s
                        e.g.:
                            <distribution>0.4 0.3 0.2 0.1</distribution>
                            This will distribute:
                            0.4 times cap charge on 1st atom
                            0.3 times cap charge on atoms connected to 1st atom
                            0.2 times cap charge on atoms connected to 2nd atom/s
                            0.1 times cap charge on atoms connected to 3rd atom/s
            RoundCharge:
                Rounds the residue charge to the nearest integer charge


            ComputeConnectivity:
                Generates a connectivity graph that can be used by Gaussian
        -->
        <action id="MoveToLayer">$(REAL)</action>
        <action id="EstimateChargeMultiplicity">
            <confirm />
        </action>
        <action id="GenerateAtomMap" />

        <run path="$(PROJECT)$(CHARGES)$(RESIDUES)_opt1" source="residueGroup">
            <nproc>$(NPROC)</nproc>
            <opt threshold="$(LOOSE)" />
            <title>First Optimisation</title>
            <layer id="$(REAL)" method="PM6" />
            <prompt />
            <updatePositions destination="residueGroup" />
        </run>

        <run path="$(PROJECT)$(CHARGES)$(RESIDUES)_opt2" source="residueGroup">
            <nproc>$(NPROC)</nproc>
            <opt threshold="$(TIGHT)" />
            <title>Second Optimisation</title>
            <layer id="$(REAL)" method="HF" basis="6-31g(d)" />
            <keywords>SCF=Conver=8</keywords>
            <updatePositions destination="residueGroup" />
        </run>

        <run path="$(PROJECT)$(CHARGES)$(RESIDUES)_charge" source="residueGroup">
            <nproc>$(NPROC)</nproc>
            <title>Charge Derivation</title>
            <layer id="$(REAL)" method="HF" basis="6-31g(d)" />
            <keywords>SCF=Conver=8 Pop=MK IOp(6/41=$(ESP_LAYERS),6/42=$(ESP_DENSITY),6/77=$(RESP_RESTRAINT))</keywords>
            <updateCharges destination="$(GEOMETRY)" />
        </run>

        <action id="RedistributeCharge">
            <distribution>0.4 0.3 0.2 0.1</distribution>
        </action>
        <action id="RoundCharge" />

    </group>
</recipe>