<?xml version="1.0" encoding="UTF-8" ?>

<!-- 

# Mutation Benchmarking Recipe

# Mutates every standard residue into its own amino acid (eg S65S) then reports on changes in positions and torsion angles

-->

<macro>

    <var id="METHOD">numerical</var>
    <var id="SOLVENT_RADIUS">1.4</var>
    <var id="GRID_RESOLUTION">2</var>

    <action id="userLoad" destination="geometry" />
    <action id="copy" source="geometry" destination="clone" />

    <action id="report" overwrite="true" source="geometry">
        <directory>$(PROJECT)/Reports</directory>
        <name>Benchmark.log</name>
        <items>
            <text>Benchmark</text>
            <text>Performing SASA Analysis</text>
        </items>
    </action>
    

    <!--Surface Analysis-->
    <action id="sasaAnalysis" source="geometry">
        <method>$(METHOD)</method>
        <solventRadius>$(SOLVENT_RADIUS)</solventRadius>
        <gridResolution>$(GRID_RESOLUTION)</gridResolution>
    </action>


    <group type="perResidue" name="residueGroup" source="geometry" var="RESIDUE_ID">

        <residueVar source="residueGroup" id="RESIDUE_STATE" type="state">
            <residueID>$(RESIDUE_ID)</residueID>
        </residueVar>

        <residueVar source="residueGroup" id="RESIDUE_NAME" type="name">
            <residueID>$(RESIDUE_ID)</residueID>
        </residueVar>

        <branch test="equal" value1="$(RESIDUE_STATE)" value2="STANDARD">
            <true>

                <var id="PROTEIN_SASA">$(sasa_$(RESIDUE_ID))</var> 

                <!--Repeat SASA for vacuum-->
                <action id="sasaAnalysis" source="residueGroup">
                    <method>$(METHOD)</method>
                    <solventRadius>$(SOLVENT_RADIUS)</solventRadius>
                    <gridResolution>$(GRID_RESOLUTION)</gridResolution>
                </action>

                <var id="VACUUM_SASA">$(sasa_$(RESIDUE_ID))</var>

                <!--Report initial properties-->
                <action id="report" overwrite="false" source="geometry">
                    <directory>$(PROJECT)/Reports</directory>
                    <name>Benchmark.log</name>
                    <items>
                        <text>Residue $(RESIDUE_ID) '$(RESIDUE_NAME)': Before mutation</text>
                        <text>SASA: Protein: $(PROTEIN_SASA) Vacuum: $(VACUUM_SASA)</text>
                        <residues residueIDs="$(RESIDUE_ID)">
                            <contact />
                            <clashScore keepParameters="true"/>
                        </residues>
                        <text></text>
                    </items>
                </action>

                <!--Perform mutation-->
                <action id="mutateResidue" source="geometry">
                    <residueID>$(RESIDUE_ID)</residueID>
                    <target>$(RESIDUE_NAME)</target>
                    <optimise>true</optimise>
                    <deltaTheta>5</deltaTheta>
                </action>

                <!--Report changes-->
                <action id="report" overwrite="false" source="geometry">
                    <directory>$(PROJECT)/Reports</directory>
                    <name>Benchmark.log</name>
                    <items>
                        <text>$(RESIDUE_ID) '$(RESIDUE_NAME)': After mutation</text>
                        <compareResidues residueIDs="$(RESIDUE_ID)" target="clone">
                            <distances heavy="true" />
                            <torsionAngles />
                        </compareResidues>
                        <residues residueIDs="$(RESIDUE_ID)">
                            <contact />
                            <clashScore keepParameters="true"/>
                        </residues>
                        <text></text>
                    </items>
                </action>

                <!--Reset geometry but keep any new parameters-->
                <action id="update" source="geometry" destination="clone" parameters="true"/>
                <action id="copy" source="clone" destination="geometry" />
                
            </true>

            <false>

                <action id="report" overwrite="false" source="geometry">
                    <directory>$(PROJECT)/Reports</directory>
                    <name>Benchmark.log</name>
                    <items>
                        <text>Skipping $(RESIDUE_ID) '$(RESIDUE_NAME)' (State: '$(RESIDUE_STATE)')</text>
                    </items>
                </action>

            </false>
        </branch>

    </group>

</macro>